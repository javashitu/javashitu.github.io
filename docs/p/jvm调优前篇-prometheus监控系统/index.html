<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="背景 基于前面的垃圾回收器的理论的学习，我们基本掌握了垃圾回收器的原理。但是这还不够，在实际的面试里，我们经常被问到的一个问题就是，&ldquo;你说一下JVM调优思路&rdquo;。为了弄明白JVM调优的思路，我们当然要实际操作一把，但是在真正开始调优之前，我们先学习一个新的技术，prometheus，它是我们接下来要学习JVM调优必须具备的技术。\nprometheus简介 简单概括prometheus是一个监控系统，能监控系统的各个指标。比如说我想知道一个接口的平均耗时是多少，最近一个小时内请求了多少次，成功了多少次。我需要一个系统能统计这个数据，并且把它展示出来，那么prometheus就是很好的解决方案。\n当然prometheus之所以强大不仅仅是因为它功能强大，还因为它的生态强大。比如prometheus统计，聚合，查询服务器数据的能力很强，但是展示并不友好(实际上prometheus原生的展示界面非常简陋)，但是它可以和Grafana结合来展示数据。当我们的服务器发生异常时，我们希望根据prometheus的指标判断出来并且发出报警通知到我们，那么我们还可以使用AlertManager来配合prometheus发出告警。\n总之prometheus是一套很强大的监控解决方案，大家记住这句话即可。\n环境搭建 为了方便大家学习，我这里讲解一下怎么搭建虚拟机下prometheus单机环境。搭建环境是centos7\nprometheus安装配置 下载prometheus安装包。官网地址https://prometheus.io/download/。不会魔法的朋友可能打不开，不过我在文章末尾放出了所有的安装包资源，大家可以自取。\n为了方便我们管理，这里我设计一个统一的管理目录/opt/data/soft，方便后续一起管理其他软件。\n下载完毕后，拷贝到/opt/data/soft/prometheus，\n1 2 3 4 5 6 7 8 # 创建目录 mkdir -p /opt/data/soft/prometheus # 解压 tar -zxvf prometheus-2.49.1.linux-amd64.tar.gz # 解压后进到解压目录里，尝试启动prometheus看看安装包坏没坏 ./prometheus --storage.tsdb.path=&#34;/opt/data/soft/prometheus/data&#34; --log.level=debug --web.enable-lifecycle --web.enable-admin-api 启动后访问网址看看页面能不能打开，这决定了后续数据能不能正确上报。\nhttp://192.168.0.150:9090/\nIP换成自己的IP。如果打不开，搜索centos7端口打不开的解决办法，比如关闭firewalld或者iptables。云服务器可能还要额外的设置，这个大家自视情况而定。\n正常大家会看到这个页面，说明启动成功了。\ngrafana安装配置 prometheus的原生界面展示的指标非常简陋，我们用grafana来展示prometheus的指标。去到官网下载https://grafana.com/grafana/download?pg=get&amp;plcmt=selfmanaged-box1-cta1下载地址\n下载后复制到/opt/data/soft/grafana目录，然后解压。命令如下\n1 2 3 4 5 6 7 8 9 10 ## 不能下载的可以在文章末尾找到我下好的软甲包 wget https://dl.grafana.com/enterprise/release/grafana-enterprise-10.2.3.linux-amd64.tar.gz tar -zxvf grafana-enterprise-10.2.3.linux-amd64.tar.gz #进到软件目录 #复制出一份配置文件，不需要更改里面的配置 cp conf/sample.ini conf/grafana.ini #启动命令 ./bin/grafana-server -config conf/grafana.ini 启动后打开网页http://192.168.0.150:3000/login，应该能看到grafana的界面.grafana的默认用户密码都是admin，第一次登录会要求修改密码。我们为了方便直接还是改为admin\n">
<title>jvm调优前篇-prometheus监控系统</title>

<link rel='canonical' href='http://localhost:1313/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/'>

<link rel="stylesheet" href="/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css"><meta property='og:title' content="jvm调优前篇-prometheus监控系统">
<meta property='og:description' content="背景 基于前面的垃圾回收器的理论的学习，我们基本掌握了垃圾回收器的原理。但是这还不够，在实际的面试里，我们经常被问到的一个问题就是，&ldquo;你说一下JVM调优思路&rdquo;。为了弄明白JVM调优的思路，我们当然要实际操作一把，但是在真正开始调优之前，我们先学习一个新的技术，prometheus，它是我们接下来要学习JVM调优必须具备的技术。\nprometheus简介 简单概括prometheus是一个监控系统，能监控系统的各个指标。比如说我想知道一个接口的平均耗时是多少，最近一个小时内请求了多少次，成功了多少次。我需要一个系统能统计这个数据，并且把它展示出来，那么prometheus就是很好的解决方案。\n当然prometheus之所以强大不仅仅是因为它功能强大，还因为它的生态强大。比如prometheus统计，聚合，查询服务器数据的能力很强，但是展示并不友好(实际上prometheus原生的展示界面非常简陋)，但是它可以和Grafana结合来展示数据。当我们的服务器发生异常时，我们希望根据prometheus的指标判断出来并且发出报警通知到我们，那么我们还可以使用AlertManager来配合prometheus发出告警。\n总之prometheus是一套很强大的监控解决方案，大家记住这句话即可。\n环境搭建 为了方便大家学习，我这里讲解一下怎么搭建虚拟机下prometheus单机环境。搭建环境是centos7\nprometheus安装配置 下载prometheus安装包。官网地址https://prometheus.io/download/。不会魔法的朋友可能打不开，不过我在文章末尾放出了所有的安装包资源，大家可以自取。\n为了方便我们管理，这里我设计一个统一的管理目录/opt/data/soft，方便后续一起管理其他软件。\n下载完毕后，拷贝到/opt/data/soft/prometheus，\n1 2 3 4 5 6 7 8 # 创建目录 mkdir -p /opt/data/soft/prometheus # 解压 tar -zxvf prometheus-2.49.1.linux-amd64.tar.gz # 解压后进到解压目录里，尝试启动prometheus看看安装包坏没坏 ./prometheus --storage.tsdb.path=&#34;/opt/data/soft/prometheus/data&#34; --log.level=debug --web.enable-lifecycle --web.enable-admin-api 启动后访问网址看看页面能不能打开，这决定了后续数据能不能正确上报。\nhttp://192.168.0.150:9090/\nIP换成自己的IP。如果打不开，搜索centos7端口打不开的解决办法，比如关闭firewalld或者iptables。云服务器可能还要额外的设置，这个大家自视情况而定。\n正常大家会看到这个页面，说明启动成功了。\ngrafana安装配置 prometheus的原生界面展示的指标非常简陋，我们用grafana来展示prometheus的指标。去到官网下载https://grafana.com/grafana/download?pg=get&amp;plcmt=selfmanaged-box1-cta1下载地址\n下载后复制到/opt/data/soft/grafana目录，然后解压。命令如下\n1 2 3 4 5 6 7 8 9 10 ## 不能下载的可以在文章末尾找到我下好的软甲包 wget https://dl.grafana.com/enterprise/release/grafana-enterprise-10.2.3.linux-amd64.tar.gz tar -zxvf grafana-enterprise-10.2.3.linux-amd64.tar.gz #进到软件目录 #复制出一份配置文件，不需要更改里面的配置 cp conf/sample.ini conf/grafana.ini #启动命令 ./bin/grafana-server -config conf/grafana.ini 启动后打开网页http://192.168.0.150:3000/login，应该能看到grafana的界面.grafana的默认用户密码都是admin，第一次登录会要求修改密码。我们为了方便直接还是改为admin\n">
<meta property='og:url' content='http://localhost:1313/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/'>
<meta property='og:site_name' content='javashitu的博客'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='prometheus' /><meta property='article:published_time' content='2024-01-16T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2024-01-16T00:00:00&#43;00:00'/><meta property='og:image' content='http://localhost:1313/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/cover.jpg' />
<meta name="twitter:title" content="jvm调优前篇-prometheus监控系统">
<meta name="twitter:description" content="背景 基于前面的垃圾回收器的理论的学习，我们基本掌握了垃圾回收器的原理。但是这还不够，在实际的面试里，我们经常被问到的一个问题就是，&ldquo;你说一下JVM调优思路&rdquo;。为了弄明白JVM调优的思路，我们当然要实际操作一把，但是在真正开始调优之前，我们先学习一个新的技术，prometheus，它是我们接下来要学习JVM调优必须具备的技术。\nprometheus简介 简单概括prometheus是一个监控系统，能监控系统的各个指标。比如说我想知道一个接口的平均耗时是多少，最近一个小时内请求了多少次，成功了多少次。我需要一个系统能统计这个数据，并且把它展示出来，那么prometheus就是很好的解决方案。\n当然prometheus之所以强大不仅仅是因为它功能强大，还因为它的生态强大。比如prometheus统计，聚合，查询服务器数据的能力很强，但是展示并不友好(实际上prometheus原生的展示界面非常简陋)，但是它可以和Grafana结合来展示数据。当我们的服务器发生异常时，我们希望根据prometheus的指标判断出来并且发出报警通知到我们，那么我们还可以使用AlertManager来配合prometheus发出告警。\n总之prometheus是一套很强大的监控解决方案，大家记住这句话即可。\n环境搭建 为了方便大家学习，我这里讲解一下怎么搭建虚拟机下prometheus单机环境。搭建环境是centos7\nprometheus安装配置 下载prometheus安装包。官网地址https://prometheus.io/download/。不会魔法的朋友可能打不开，不过我在文章末尾放出了所有的安装包资源，大家可以自取。\n为了方便我们管理，这里我设计一个统一的管理目录/opt/data/soft，方便后续一起管理其他软件。\n下载完毕后，拷贝到/opt/data/soft/prometheus，\n1 2 3 4 5 6 7 8 # 创建目录 mkdir -p /opt/data/soft/prometheus # 解压 tar -zxvf prometheus-2.49.1.linux-amd64.tar.gz # 解压后进到解压目录里，尝试启动prometheus看看安装包坏没坏 ./prometheus --storage.tsdb.path=&#34;/opt/data/soft/prometheus/data&#34; --log.level=debug --web.enable-lifecycle --web.enable-admin-api 启动后访问网址看看页面能不能打开，这决定了后续数据能不能正确上报。\nhttp://192.168.0.150:9090/\nIP换成自己的IP。如果打不开，搜索centos7端口打不开的解决办法，比如关闭firewalld或者iptables。云服务器可能还要额外的设置，这个大家自视情况而定。\n正常大家会看到这个页面，说明启动成功了。\ngrafana安装配置 prometheus的原生界面展示的指标非常简陋，我们用grafana来展示prometheus的指标。去到官网下载https://grafana.com/grafana/download?pg=get&amp;plcmt=selfmanaged-box1-cta1下载地址\n下载后复制到/opt/data/soft/grafana目录，然后解压。命令如下\n1 2 3 4 5 6 7 8 9 10 ## 不能下载的可以在文章末尾找到我下好的软甲包 wget https://dl.grafana.com/enterprise/release/grafana-enterprise-10.2.3.linux-amd64.tar.gz tar -zxvf grafana-enterprise-10.2.3.linux-amd64.tar.gz #进到软件目录 #复制出一份配置文件，不需要更改里面的配置 cp conf/sample.ini conf/grafana.ini #启动命令 ./bin/grafana-server -config conf/grafana.ini 启动后打开网页http://192.168.0.150:3000/login，应该能看到grafana的界面.grafana的默认用户密码都是admin，第一次登录会要求修改密码。我们为了方便直接还是改为admin\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/cover.jpg' />
    <link rel="shortcut icon" href="/javashitu.jpg" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/javashitu_hu_4b8114d532ed8b7b.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">javashitu的博客</a></h1>
            <h2 class="site-description">退笔如山未足珍，读书万卷始通神</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/javashitu'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友情链接</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#prometheus安装配置">prometheus安装配置</a></li>
    <li><a href="#grafana安装配置">grafana安装配置</a></li>
  </ol>

  <ol>
    <li><a href="#指标的格式">指标的格式</a></li>
    <li><a href="#counter">Counter</a></li>
    <li><a href="#gauge">Gauge</a></li>
    <li><a href="#histogram">Histogram</a></li>
    <li><a href="#summary">Summary</a></li>
    <li><a href="#promql">PromQL</a></li>
  </ol>

  <ol>
    <li><a href="#接入prometheus数据源">接入prometheus数据源</a></li>
    <li><a href="#创建自定义面板">创建自定义面板</a></li>
    <li><a href="#导入预设面板">导入预设面板</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/">
                <img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/cover_hu_981069e619b1dfa7.jpg"
                        srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/cover_hu_981069e619b1dfa7.jpg 800w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/cover_hu_90fd20c4179a133a.jpg 1600w"
                        width="800" 
                        height="465" 
                        loading="lazy"
                        alt="Featured image of post jvm调优前篇-prometheus监控系统" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E7%9B%91%E6%8E%A7/" >
                监控
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/">jvm调优前篇-prometheus监控系统</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-1-16</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="背景">背景
</h1><p>基于前面的垃圾回收器的理论的学习，我们基本掌握了垃圾回收器的原理。但是这还不够，在实际的面试里，我们经常被问到的一个问题就是，&ldquo;你说一下JVM调优思路&rdquo;。为了弄明白JVM调优的思路，我们当然要实际操作一把，但是在真正开始调优之前，我们先学习一个新的技术，prometheus，它是我们接下来要学习JVM调优必须具备的技术。</p>
<h1 id="prometheus简介">prometheus简介
</h1><p>简单概括prometheus是一个监控系统，能监控系统的各个指标。比如说我想知道一个接口的平均耗时是多少，最近一个小时内请求了多少次，成功了多少次。我需要一个系统能统计这个数据，并且把它展示出来，那么prometheus就是很好的解决方案。</p>
<p>当然prometheus之所以强大不仅仅是因为它功能强大，还因为它的生态强大。比如prometheus统计，聚合，查询服务器数据的能力很强，但是展示并不友好(实际上prometheus原生的展示界面非常简陋)，但是它可以和Grafana结合来展示数据。当我们的服务器发生异常时，我们希望根据prometheus的指标判断出来并且发出报警通知到我们，那么我们还可以使用AlertManager来配合prometheus发出告警。</p>
<p>总之prometheus是一套很强大的监控解决方案，大家记住这句话即可。</p>
<h1 id="环境搭建">环境搭建
</h1><p>为了方便大家学习，我这里讲解一下怎么搭建虚拟机下prometheus单机环境。搭建环境是centos7</p>
<h2 id="prometheus安装配置">prometheus安装配置
</h2><p>下载prometheus安装包。官网地址https://prometheus.io/download/。不会魔法的朋友可能打不开，不过我在文章末尾放出了所有的安装包资源，大家可以自取。</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240117065036202.jpg"
	width="2560"
	height="1255"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240117065036202_hu_c2aa2dc52e1c4dd4.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240117065036202_hu_be60d79ba91f88b7.jpg 1024w"
	loading="lazy"
	
		alt="image-20240117065036202"
	
	
		class="gallery-image" 
		data-flex-grow="203"
		data-flex-basis="489px"
	
></p>
<p>为了方便我们管理，这里我设计一个统一的管理目录/opt/data/soft，方便后续一起管理其他软件。</p>
<p>下载完毕后，拷贝到/opt/data/soft/prometheus，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建目录</span>
</span></span><span class="line"><span class="cl">mkdir -p /opt/data/soft/prometheus
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 解压</span>
</span></span><span class="line"><span class="cl">tar -zxvf prometheus-2.49.1.linux-amd64.tar.gz
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 解压后进到解压目录里，尝试启动prometheus看看安装包坏没坏</span>
</span></span><span class="line"><span class="cl">./prometheus --storage.tsdb.path<span class="o">=</span><span class="s2">&#34;/opt/data/soft/prometheus/data&#34;</span> --log.level<span class="o">=</span>debug --web.enable-lifecycle --web.enable-admin-api
</span></span></code></pre></td></tr></table>
</div>
</div><p>启动后访问网址看看页面能不能打开，这决定了后续数据能不能正确上报。</p>
<p>http://192.168.0.150:9090/</p>
<p>IP换成自己的IP。如果打不开，搜索centos7端口打不开的解决办法，比如关闭firewalld或者iptables。云服务器可能还要额外的设置，这个大家自视情况而定。</p>
<p>正常大家会看到这个页面，说明启动成功了。</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240117071225964.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240117071225964_hu_cddba2f7d27f586e.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240117071225964_hu_2bf9af910f4e7ae1.jpg 1024w"
	loading="lazy"
	
		alt="image-20240117071225964"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<h2 id="grafana安装配置">grafana安装配置
</h2><p>prometheus的原生界面展示的指标非常简陋，我们用grafana来展示prometheus的指标。去到官网下载https://grafana.com/grafana/download?pg=get&amp;plcmt=selfmanaged-box1-cta1下载地址</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240118223426579.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240118223426579_hu_78125a33d29cb2e9.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240118223426579_hu_90b0d5d0ee2b4b5e.jpg 1024w"
	loading="lazy"
	
		alt="image-20240118223426579"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>下载后复制到/opt/data/soft/grafana目录，然后解压。命令如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 不能下载的可以在文章末尾找到我下好的软甲包
</span></span><span class="line"><span class="cl">wget https://dl.grafana.com/enterprise/release/grafana-enterprise-10.2.3.linux-amd64.tar.gz
</span></span><span class="line"><span class="cl">tar -zxvf grafana-enterprise-10.2.3.linux-amd64.tar.gz
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#进到软件目录
</span></span><span class="line"><span class="cl">#复制出一份配置文件，不需要更改里面的配置
</span></span><span class="line"><span class="cl">cp conf/sample.ini conf/grafana.ini
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#启动命令 
</span></span><span class="line"><span class="cl">./bin/grafana-server -config conf/grafana.ini
</span></span></code></pre></td></tr></table>
</div>
</div><p>启动后打开网页http://192.168.0.150:3000/login，应该能看到grafana的界面.grafana的默认用户密码都是admin，第一次登录会要求修改密码。我们为了方便直接还是改为admin</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240118224449070.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240118224449070_hu_6a841c7fc6d6ae1e.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240118224449070_hu_4783d291dad7c2a4.jpg 1024w"
	loading="lazy"
	
		alt="image-20240118224449070"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>进入grafana之后</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240118224725296.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240118224725296_hu_dcb1d67326044a71.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240118224725296_hu_e985ea78b4ff2fd8.jpg 1024w"
	loading="lazy"
	
		alt="image-20240118224725296"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<h1 id="springboot项目整合prometheus">SpringBoot项目整合Prometheus
</h1><p>有了环境，我们还要有展示的指标，所以这里我搭建一个示例项目用来展示prometheus的指标用法。</p>
<p>maven依赖</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">		<span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&lt;groupId&gt;</span>io.micrometer<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&lt;artifactId&gt;</span>micrometer-registry-prometheus<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>application配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">management</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">base-path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exposure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="l">prometheus</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8113</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">export</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">application</span><span class="p">:</span><span class="w"> </span><span class="l">${spring.application.name}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后启动服务，访问接口http://192.168.66.120:8113/actuator/prometheus，如果能看到展示的指标说明配置正确。</p>
<p>这里我们就搭建起来了prometheus的使用环境，具体的指标用法在后面。</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120114752660.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120114752660_hu_697f5e6b49a63b4f.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120114752660_hu_c3cb6421b0b38996.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120114752660"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<h1 id="prometheus配置拉指标数据源">prometheus配置拉指标数据源
</h1><p>peometheus会定期去拉取服务器的指标数据，所以我们还要在prometheus上配置需要拉取指标的服务地址。</p>
<p>去到prometheus的安装目录，在prometheus.yml文件里更改配置，添加我们要采集的spring服务地址</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">global</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w"> </span><span class="c"># 全局的采集数据周期</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">evaluation_interval</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w"> </span><span class="c"># Evaluate rules every 15 seconds. The default is every 1 minute.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scrape_timeout</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w"> </span><span class="c"># 全局的采集超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;prometheus-demo&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l">10s</span><span class="w"> </span><span class="c">#本采集任务的采集数据周期 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">scrape_timeout</span><span class="p">:</span><span class="w"> </span><span class="l">20s</span><span class="w"> </span><span class="c">#本采集任务的超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metrics_path</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;/actuator/prometheus&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;192.168.66.120:8113&#39;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>拉取成功后打开prometheus的web界面，找到我们配置的spring服务，看是不是成功被采集到了</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120125905232.jpg"
	width="2560"
	height="1255"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120125905232_hu_d4dad432d709e40c.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120125905232_hu_6f76adce5161b4db.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120125905232"
	
	
		class="gallery-image" 
		data-flex-grow="203"
		data-flex-basis="489px"
	
></p>
<h1 id="prometheus语法">prometheus语法
</h1><h2 id="指标的格式">指标的格式
</h2><p>下面是一个指标的典型格式。custom_message_length_total是指标名字，大括号内的内容被称为labels，labels内有3个标签，同样的指标名字，标签不一样，也是不一样的指标。最后的5.0表示指标的值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">custom_message_length_total</span><span class="p">{</span><span class="err">application=</span><span class="nt">&#34;prometheus_study&#34;</span><span class="p">,</span><span class="err">message_length=</span><span class="nt">&#34;10&#34;</span><span class="p">,</span><span class="err">message_time=</span><span class="nt">&#34;2024-01-20&#34;</span><span class="p">,}</span> <span class="mf">5.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>prometheus有4中指标，我们分别介绍</p>
<h2 id="counter">Counter
</h2><p>Counter是一个只增不减的指标，可以用counter来记录服务的请求数，已完成的任务数，发生错误的次数等。通过labels指定标签，inc方法增加次数，或者add(float)增加指定次数。</p>
<p>一个label指标例子。我们统计一天收到消息条数，并根据消息的长度做区分。</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120142914839.jpg"
	width="1981"
	height="400"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120142914839_hu_ecb82fddbec5e9a8.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120142914839_hu_6ce12fee5847614c.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120142914839"
	
	
		class="gallery-image" 
		data-flex-grow="495"
		data-flex-basis="1188px"
	
></p>
<p>指标格式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">custom_message_length_total</span><span class="p">{</span><span class="err">application=</span><span class="nt">&#34;prometheus_study&#34;</span><span class="p">,</span><span class="err">message_length=</span><span class="nt">&#34;5&#34;</span><span class="p">,</span><span class="err">message_time=</span><span class="nt">&#34;2024-01-20&#34;</span><span class="p">,}</span> <span class="mf">4.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>访问spring的指标暴露接口 http://192.168.66.120:8113/actuator/prometheus</p>
<p>可以看到我们的自定义的指标</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120143046371.jpg"
	width="1997"
	height="499"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120143046371_hu_ae95036df4c14039.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120143046371_hu_ca78c30e7ca33694.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120143046371"
	
	
		class="gallery-image" 
		data-flex-grow="400"
		data-flex-basis="960px"
	
></p>
<h2 id="gauge">Gauge
</h2><p>仪表盘代表一种可以随意变化的指标，比如内存使用率这种指标，或者并发请求数量。也是使用labels来指定标签名称。</p>
<p>注意这个值时随时间变化的，而且两次记录之间有可能丢失数据，随着时间周期的粒度变大，丢失关键变化的情况会增多。</p>
<p>我们设计一个队列存储所有收到的消息。然后用guage记录队列里消息的条数。</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120150708805.jpg"
	width="1825"
	height="789"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120150708805_hu_d7feebd8362c7fe0.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120150708805_hu_9a0884dc69bb1440.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120150708805"
	
	
		class="gallery-image" 
		data-flex-grow="231"
		data-flex-basis="555px"
	
></p>
<p>从http://192.168.66.120:8113/actuator/prometheus 里查看我们队列里消息的条数，显示有5条。</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120150632493.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120150632493_hu_5a17ef051b4ced2a.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120150632493_hu_70a04a43422ccfb0.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120150632493"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>我们发送一条remove指令，然后发现队列里消息的条数变少了</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120151442825.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120151442825_hu_cdd4b90f79fac11c.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120151442825_hu_3b9556593bf54aff.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120151442825"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<h2 id="histogram">Histogram
</h2><p>直方图，它其实是将指标按照一定的规则分组后的指标。label中的标签就是分组的规则。每个创建的指标后面就会存在一个&quot;指标名__histogram&quot;的指标，表示分组后的结果。</p>
<p>这里我用Histogram来统计接口耗时</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120161338402.jpg"
	width="1862"
	height="652"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120161338402_hu_ea07af37b666b357.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120161338402_hu_ad33c0a9e5c95d21.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120161338402"
	
	
		class="gallery-image" 
		data-flex-grow="285"
		data-flex-basis="685px"
	
></p>
<p>可以看到，统计出耗时在50ms以下的请求有1个，100ms以下有2个，200ms以下5个，500ms以下12个，1000ms以下17个。</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120161417738.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120161417738_hu_61776e2d6480e235.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120161417738_hu_fb05e57e3d6518.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120161417738"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>细心的读者肯定发现了，除了HistogramName_Hitogram指标外，还有 HistogramName_seconds_bucket这种指标。这两者其实是一个指标，只是表示形式不一样，大家可以对照着看指标值是不是都一样。 HistogramName_Hitogram是把每个labels对应的标签分配进bucket，bucket分组就是我们设置的分组规则。实际记录的值除了每个HistogramName_bucket指标外还存在HistogramName_count和HistogramName_sum，分别表示所有观测到的事件总次数和观测到的事件的值的和。在HistogramName_bucket中当上界le为+Inf时，它的值为所有接受到的事件次数，这个结果就和HistogramName_Count一样了。</p>
<h2 id="summary">Summary
</h2><p>Summary的含义和Histogram表达的含义一样，都是对指标进行聚合后的展示。但是Summary在一些计算时会直接在客户端计算，而Histogram则是在服务端计算，比如计算一个指标的中位数。</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120165930047.jpg"
	width="1794"
	height="877"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120165930047_hu_ce70e1e8c8a91f2.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120165930047_hu_447fb760ae6909ff.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120165930047"
	
	
		class="gallery-image" 
		data-flex-grow="204"
		data-flex-basis="490px"
	
></p>
<p>可以看到Summary指标和Histogram指标的统计结果完全一样</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120165845376.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120165845376_hu_8e32177077697545.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120165845376_hu_211bb41229826878.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120165845376"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<h2 id="promql">PromQL
</h2><p>我们的指标其实是存储在prometheus服务器上的，以上所有指标都有对应的函数，和语法配合函数可以更准确的展示出对应的数据变化规律。专门操作prometheus指标的语法就是PromQL。</p>
<p>接下来我们介绍如何使用PromQL更好的展示指标。</p>
<p>我们知道custom_message_send_cost_time_histogram指标代表每个耗时阶段的请求个数。比如这里耗时200ms以下的请求1个，耗时500ms以下的请求7个，那么耗时100ms - 500ms之间的请求有多少个呢，虽然我们口算也可以，但是数据量很大时明显就不能口算了。我们用PromQL计算一下。</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120171405245.jpg"
	width="1725"
	height="540"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120171405245_hu_9835e1c7608cb0d.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120171405245_hu_fd1acebe58881060.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120171405245"
	
	
		class="gallery-image" 
		data-flex-grow="319"
		data-flex-basis="766px"
	
></p>
<p>去到http://192.168.66.69:9090/graph输入计算函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">scalar(custom_message_send_cost_time_histogram{application=&#34;prometheus_study&#34;,le=&#34;0.5&#34;,})-scalar(custom_message_send_cost_time_histogram{application=&#34;prometheus_study&#34;,le=&#34;0.2&#34;,})</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到展示的计算结果是6</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120171549504.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120171549504_hu_cb730c481e306ad0.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120171549504_hu_54812d1ede4872c7.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120171549504"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>PromQL的功能很强大，函数也很丰富，大家感兴趣自己在去了解。</p>
<h1 id="grafana接入prometheus">Grafana接入prometheus
</h1><p>上面我们可以看到，prometheus展示的界面太丑了，我们一开始介绍了grafana是用来替换prometheus展示数据的，这里介绍下怎么用Grafana接入Prometheus。</p>
<h2 id="接入prometheus数据源">接入prometheus数据源
</h2><p>进入主界面选择接入prometheus数据源</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120195338849.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120195338849_hu_fb76dc98be75ca8a.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120195338849_hu_7a0cece1af8ad771.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120195338849"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>选创建新数据源</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120195402635.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120195402635_hu_d515298b7f80a3fc.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120195402635_hu_b042be13d96be9d1.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120195402635"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>填好数据源名字和prometheus的访问地址后保存</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120195548854.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120195548854_hu_3c36017534392f7e.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120195548854_hu_4c773f5e4cf17949.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120195548854"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<h2 id="创建自定义面板">创建自定义面板
</h2><p>创建新看板</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120195938838.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120195938838_hu_26c03021e8b2f314.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120195938838_hu_632c40152c8e22c6.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120195938838"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200015532.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200015532_hu_e58edf32e8164f09.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200015532_hu_c4660569eee3ba39.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120200015532"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>数据源选我们刚才新建的prometheus-demo</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200052764.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200052764_hu_725a99950a7899b6.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200052764_hu_e06ac977a66337b2.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120200052764"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>还要再选一遍数据源</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200424237.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200424237_hu_ea9974b86067db17.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200424237_hu_683c3058f2636c95.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120200424237"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>我这里选择我们创建的记录接口耗时的指标custom_message_send_cost_time_histogram</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200509660.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200509660_hu_45b535565aee8a63.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200509660_hu_f30a114a934f8635.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120200509660"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>label里的标签也得选，然后预览。然后保存</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200612651.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200612651_hu_259cdd364da9f483.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200612651_hu_91f698dd7955ef0c.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120200612651"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200717059.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200717059_hu_8093155faf205e66.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200717059_hu_a632c205654e9895.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120200717059"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>到这里，我们自己创建的指标就可以展示了。最终结果</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200735790.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200735790_hu_23337bb3533e49a.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120200735790_hu_3ad04b37d61c68b2.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120200735790"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<h2 id="导入预设面板">导入预设面板
</h2><p>从上面的创建步骤来看，创建一个面板还是不简单，而且如果我们要用一些PromQL来创建面板时，那步骤会更加复杂。而且我们的Spring项目有那么多指标，总不能全部都由我们新建吧，所以我们还要学会导入其他人开发好的面板。</p>
<p>好在Spring有非常好的生态，社区里已经有人建好了一套Spring程序的面板，里面包含了大部分常用的监控指标，我们可以直接导入。</p>
<p>模板官网 <a class="link" href="https://grafana.com/grafana/dashboards/"  target="_blank" rel="noopener"
    >https://grafana.com/grafana/dashboards/</a></p>
<p>找到任意的我们想要下载的模板，下载JSON配置</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120201700458.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120201700458_hu_cc62774817c38fa5.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120201700458_hu_5abf76a884c7a4f1.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120201700458"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>在看板界面选择导入我们想要的看板</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120201812667.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120201812667_hu_90f7d70b611bf8bd.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120201812667_hu_12fb4b24140d421b.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120201812667"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>导入时数据源选择我们创建的prometheus-demo</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120201915045.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120201915045_hu_a089c26d223e29fa.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120201915045_hu_b38806ee27957b19.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120201915045"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>保存后就能看到我们想要的看板</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120202704927.jpg"
	width="2560"
	height="1230"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120202704927_hu_96887d11f0066b24.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120202704927_hu_5448eadc592c0ae9.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120202704927"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="499px"
	
></p>
<p>这里我推荐一个看板4701，这个看板是监控JVM信息的，用我们配置的Spring项目就可以展示。</p>
<p>这个面板非常全面，是我们后续讲JVM调优实践必须要用的。我替大大家下好了。</p>
<p><img src="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120203226105.jpg"
	width="1656"
	height="700"
	srcset="/p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120203226105_hu_256f05bdd59480bd.jpg 480w, /p/jvm%E8%B0%83%E4%BC%98%E5%89%8D%E7%AF%87-prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/index.assets/image-20240120203226105_hu_16750ebe46000976.jpg 1024w"
	loading="lazy"
	
		alt="image-20240120203226105"
	
	
		class="gallery-image" 
		data-flex-grow="236"
		data-flex-basis="567px"
	
></p>
<p>还有一些监控服务器状态的看板，不过需要安装额外的指标采集程序，我就不演示了。也不是重点，大家知道就行了。</p>
<h1 id="end">END
</h1><p>到这里关于prometheus的知识就讲完了，prometheus是后面JVM调优实施的必要条件，大家一定要掌握。另外本文所有用到的资源，配置，以及代码我已经打包好了，大家在不会魔法就自己下载然后照着操作就行。</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/prometheus/">Prometheus</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2023 - 
        
        2025 javashitu的博客
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.6f85c0570361e9fcd383cd0c8cdc21d0052ff5c72675accf2fc6b86ed3b3e58b.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
